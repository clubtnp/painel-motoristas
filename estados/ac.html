<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Rede de Motoristas</title>
  <style>
    /* Estilos Gerais */
    body { font-family: Arial, sans-serif; background: #0f172a; color: #fff; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 40px 16px; box-sizing: border-box; }
    .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 24px; }
    .box { background: #020617; padding: 24px; border-radius: 16px; box-shadow: 0 0 20px rgba(0,0,0,.5); }
    
    /* Estilo da Capa */
    .capa-container { text-align: center; margin-bottom: 8px; }
    .capa-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #22c55e; object-fit: cover; box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
    .capa-titulo { margin-top: 12px; font-size: 18px; font-weight: bold; color: #22c55e; }

    h1 { text-align: center; margin-bottom: 10px; font-size: 22px; }
    p { text-align: center; font-size: 14px; opacity: .8; }
    select, button { width: 100%; padding: 14px; margin-top: 16px; border-radius: 12px; border: none; font-size: 16px; }
    select { background: #1e293b; color: #fff; }
    button { background: #22c55e; color: #020617; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
    .btn-secondary { background: #1e293b; color: #fff; }
    button:hover { opacity: .9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #status { text-align: center; font-size: 12px; margin-top: 8px; color: #22c55e; display: none; }

    /* Estilos da √Årvore Vertical */
    #container-arvore { 
      margin-top: 20px; 
      overflow: auto; 
      height: 255px; 
      border: 1px solid #1e293b; 
      border-radius: 12px; 
      background: #020617;
      padding: 20px 0; 
      box-sizing: border-box;
      position: relative;
    }
    
    .filtro-categoria {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      background: #1e293b;
      color: #fff;
      border: 1px solid #334155;
      font-size: 14px;
      outline: none;
    }
          
    .filtro-categoria:focus {
      border-color: #22c55e;
    }

    #wrapper-arvore { 
      display: flex; 
      flex-direction: column; 
      gap: 20px; 
      width: max-content; 
      min-width: 100%;
      padding: 0 20px;
      align-items: center; 
    }

    #container-arvore::-webkit-scrollbar { width: 8px; height: 8px; }
    #container-arvore::-webkit-scrollbar-track { background: #020617; border-radius: 10px; }
    #container-arvore::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    #container-arvore::-webkit-scrollbar-thumb:hover { background: #22c55e; }

    .nivel-arvore { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 15px; 
      min-width: max-content; 
      position: relative;
    }

    .label-nivel { 
      background: #334155; 
      color: #fff; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 9px; 
      font-weight: bold; 
      text-transform: uppercase; 
      opacity: 0.6; 
      flex-shrink: 0; 
    }

    .item-motorista { 
      background: #1e293b; 
      border-radius: 8px; 
      border: 1px solid #334155; 
      cursor: pointer; 
      transition: all 0.2s; 
      flex-shrink: 0; 
      width: 110px; 
      height: 38px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
    }

    .item-motorista span { 
      white-space: nowrap; 
      font-size: 12px; 
      font-weight: 500;
      color: #e2e8f0;
    }

    .item-motorista:hover { 
      background-color: #334155; 
      transform: scale(1.05); 
      border-color: #22c55e; 
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
    }

    /* Estilos do Carrossel */
    .carrossel-container { position: relative; margin-top: 16px; background: #1e293b; border-radius: 12px; padding: 16px; border: 1px solid #334155; min-height: 370px; display: flex; align-items: center; justify-content: center; }
    .carrossel-wrapper { display: flex; overflow: hidden; width: 100%; border-radius: 8px; position: relative; min-height: 330px; }
    .carrossel-item { flex: 0 0 100%; display: flex; flex-direction: column; gap: 12px; transition: transform 0.3s ease; align-items: center; text-align: center; position: absolute; top: 0; left: 0; width: 100%; }
    .grupo-imagem { width: 150px; height: 150px; border-radius: 12px; object-fit: cover; background: #0f172a; border: 1px solid #334155; }
    .grupo-info { display: flex; flex-direction: column; gap: 6px; width: 100%; }
    .grupo-nome { font-size: 18px; font-weight: bold; color: #22c55e; line-height: 1.2; cursor: pointer; padding: 0 10px; word-wrap: break-word; }
    .grupo-categoria { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-ver-mais { background: #334155; color: #fff; border: 1px solid #475569; border-radius: 8px; padding: 6px 16px; font-size: 12px; font-weight: bold; cursor: pointer; }
    .grupo-botao { 
      min-height: 44px; 
      display: flex;
      align-items: center;
      justify-content: center }
    
    .carrossel-nav { 
      position: absolute; top: 50%; transform: translateY(-50%); 
      background: rgba(34, 197, 94, 0.8); color: #020617; border: none; 
      width: 36px; height: 36px; border-radius: 50%; cursor: pointer; 
      font-size: 18px; font-weight: bold; z-index: 10; 
      display: flex; align-items: center; justify-content: center; 
    }
    .carrossel-nav.prev { left: 8px; }
    .carrossel-nav.next { right: 8px; }

    .carrossel-dots { 
      display: flex; justify-content: center; align-items: center; 
      gap: 6px; margin-top: 14px; min-height: 32px; flex-wrap: wrap;
    }

    .num-page { 
      min-width: 30px; height: 30px; padding: 0 4px; border-radius: 6px; 
      background: #1e293b; color: #fff; font-size: 12px; font-weight: bold;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      border: 1px solid #334155; transition: 0.2s;
    }

    .num-page.active { 
      background: #22c55e; color: #020617; border-color: #22c55e; 
    }

    .num-page.dots { 
      background: transparent; border: none; cursor: default; color: #94a3b8; 
    }

    .num-page:hover:not(.dots):not(.active) { 
      background: #334155; border-color: #22c55e; 
    }

    .carrossel-vazio { 
      text-align: center; color: #94a3b8; font-style: italic; padding: 20px; 
    }

    /* Modal */
    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.85); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 100000; 
      backdrop-filter: blur(5px); 
      padding: 20px;
      box-sizing: border-box;
    }
    
    .modal-content { 
      background: #1e293b; 
      padding: 24px; 
      border-radius: 20px; 
      width: 100%;
      max-width: 360px; 
      text-align: center; 
      border: 1px solid #334155; 
      display: flex; 
      flex-direction: column; 
      max-height: 85vh; 
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      position: relative;
      margin: auto;
    }

    .modal-descricao-scroll { 
      flex: 1; 
      overflow-y: auto; 
      overflow-x: hidden; 
      padding: 15px; 
      background: #0f172a; 
      border-radius: 12px; 
      text-align: left; 
      margin: 15px 0; 
      border: 1px solid #334155;
      -webkit-overflow-scrolling: touch; 
    }

    .modal-descricao-scroll p {
      margin: 0;
      font-size: 14px;
      line-height: 1.6;
      color: #cbd5e1;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }

    .modal-descricao-scroll::-webkit-scrollbar { width: 8px; }
    .modal-descricao-scroll::-webkit-scrollbar-track { background: #020617; border-radius: 10px; }
    .modal-descricao-scroll::-webkit-scrollbar-thumb { background: #22c55e; border-radius: 10px; border: 2px solid #0f172a; }
  </style>
</head>
<body>

  <div class="container">
    <div class="capa-container">
      <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663183776805/TBToCHjaxmWFWXCg.png" alt="Capa" class="capa-img">
      <div class="capa-titulo">Pessoas Colaborativas ganham at√© dormindo</div>
    </div>

    <div class="box">
      <h1>Buscar motoristas</h1>
      <p>Escolha sua cidade</p>
      <select id="selectCidade"><option value="">Carregando cidades...</option></select>
      <button id="btnBuscar">Buscar motoristas</button>
      <div id="status"></div>
    </div>

    <div class="box">
      <h1>√Årvore da Rede</h1>
      <p>Arraste para explorar</p>
      <div id="container-arvore"><div id="wrapper-arvore"></div></div>
      <button id="btnCadastrarArvore">Cadastrar na √°rvore</button>
    </div>

    <div class="box">
      <h1>Grupo de Motoristas</h1>
      <div id="carrossel-motoristas" class="carrossel-container"></div>
      <div id="dots-motoristas" class="carrossel-dots"></div>
      <select id="filtro-motoristas" class="filtro-categoria">
        <option value="">Filtrar por Categoria (Motoristas )</option>
      </select>
      <button class="btn-secondary" id="btnCadastrarGrupo">Cadastrar meu grupo</button>
    </div>

    <div class="box">
      <h1>Grupos de Com√©rcios</h1>
      <div id="carrossel-comercio" class="carrossel-container"></div>
      <div id="dots-comercio" class="carrossel-dots"></div>
      <select id="filtro-comercio" class="filtro-categoria">
        <option value="">Filtrar por Categoria (Com√©rcio)</option>
      </select>
    </div>

    <div class="box">
      <h1>Instagram</h1>
      <div id="carrossel-instagram" class="carrossel-container"></div>
      <div id="dots-instagram" class="carrossel-dots"></div>
      <select id="filtro-instagram" class="filtro-categoria">
        <option value="">Filtrar por Categoria (Instagram)</option>
      </select>
    </div>

    <!-- Modal para detalhes -->
    <div id="modal-overlay" class="modal-overlay">
      <div id="modal-content" class="modal-content"></div>
    </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzIsmfQTV5OO1ubdGsTeCPHYSd5JzIp1NVIVvBlPIHRXkSC_FpO_gx-nuu05cpTXdIC/exec"; // **ATUALIZE COM O SEU URL**
    let cidadeAtual = '';

    // Estados para pagina√ß√£o e controle
    const motoristasState = { page: 1, pageSize: 200, total: 0, loading: false, allItems: [] };
    const gruposMotoristasState = { page: 1, pageSize: 5, total: 0, loading: false, allItems: [], index: 0 };
    const gruposComercioState = { page: 1, pageSize: 5, total: 0, loading: false, allItems: [], index: 0 };
    const instagramState = { page: 1, pageSize: 5, total: 0, loading: false, allItems: [], index: 0 };

    document.addEventListener('DOMContentLoaded', () => {
      carregarCidades();
      document.getElementById('btnBuscar').addEventListener('click', buscarTodosDados);
      document.getElementById('selectCidade').addEventListener('change', (e) => {
        cidadeAtual = e.target.value;
        if (cidadeAtual) buscarTodosDados();
      });

      // Lazy load para √°rvore
      document.getElementById('container-arvore').addEventListener('scroll', (e) => {
        const { scrollTop, scrollHeight, clientHeight } = e.target;
        if (scrollTop + clientHeight >= scrollHeight - 50) carregarMaisMotoristas();
      });

      // Fechar modal
      document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'modal-overlay') fecharModal();
      });
    });

    function showStatus(msg, isError = false) {
      const status = document.getElementById('status');
      status.innerText = msg;
      status.style.display = 'block';
      status.style.color = isError ? '#ef4444' : '#22c55e';
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    async function carregarCidades() {
      const select = document.getElementById('selectCidade');
      try {
        const res = await fetch(`${WEB_APP_URL}?action=listCidades`);
        const cidades = await res.json();
        select.innerHTML = '<option value="">Selecione uma cidade</option>';
        cidades.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c; opt.innerText = c;
          select.appendChild(opt);
        });
      } catch (e) {
        select.innerHTML = '<option value="">Erro ao carregar</option>';
      }
    }

    function limparTudo() {
      document.getElementById('wrapper-arvore').innerHTML = '';
      [motoristasState, gruposMotoristasState, gruposComercioState, instagramState].forEach(s => {
        s.page = 1; s.total = 0; s.allItems = []; s.loading = false; if(s.index !== undefined) s.index = 0;
      });
    }

    async function buscarTodosDados() {
      if (!cidadeAtual) return showStatus('Selecione uma cidade primeiro.', true);
      limparTudo();
      showStatus('Buscando dados...');
      try {
        // Busca paralela para ser mais r√°pido
        await Promise.all([
          carregarMotoristas(true),
          carregarGrupos('motoristas', true),
          carregarGrupos('comercio', true),
          carregarInstagram(true)
        ]);
        hideStatus();
      } catch (e) {
        showStatus('Erro ao carregar dados.', true);
      }
    }

    async function carregarMotoristas(reset = false) {
      if (motoristasState.loading) return;
      motoristasState.loading = true;
      try {
        const res = await fetch(`${WEB_APP_URL}?action=listMotoristas&cidade=${cidadeAtual}&page=${motoristasState.page}`);
        const data = await res.json();
        if (data.erro) throw new Error(data.mensagem);
        
        motoristasState.allItems = motoristasState.allItems.concat(data.motoristas);
        motoristasState.total = data.total;
        motoristasState.page++;
        renderizarArvore();
      } catch (e) {
        console.error('Erro motoristas:', e);
      } finally {
        motoristasState.loading = false;
      }
    }

    function carregarMaisMotoristas() {
      if (motoristasState.allItems.length < motoristasState.total) carregarMotoristas();
    }

    function renderizarArvore() {
      const wrapper = document.getElementById('wrapper-arvore');
      wrapper.innerHTML = '';
      const lista = motoristasState.allItems;
      let i = 0, tam = 3;
      let nivelNum = 1;
      while (i < lista.length) {
        const nivel = lista.slice(i, i + tam);
        const div = document.createElement('div');
        div.className = 'nivel-arvore';
        div.innerHTML = `<div class="label-nivel">N√≠vel ${nivelNum}</div>`;
        nivel.forEach(m => {
          const item = document.createElement('div');
          item.className = 'item-motorista';
          item.innerHTML = `<span>${(m.nome || 'Motorista').split(' ')[0]}</span>`;
          item.onclick = () => abrirModalMotorista(m.id);
          div.appendChild(item);
        });
        div.innerHTML += `<div class="label-nivel">N√≠vel ${nivelNum}</div>`;
        wrapper.appendChild(div);
        i += tam; tam += 2; nivelNum++;
      }
    }

    async function carregarGrupos(tipo, reset = false) {
      const state = tipo === 'motoristas' ? gruposMotoristasState : gruposComercioState;
      if (state.loading) return;
      state.loading = true;
      try {
        const res = await fetch(`${WEB_APP_URL}?action=listGrupos&type=${tipo}&cidade=${cidadeAtual}&page=${state.page}`);
        const data = await res.json();
        if (data.erro) throw new Error(data.mensagem);

        state.allItems = state.allItems.concat(data.grupos);
        state.total = data.total;
        state.page++;
        renderizarCarrossel(tipo);
        atualizarFiltros(tipo);
      } catch (e) {
        console.error(`Erro grupos ${tipo}:`, e);
      } finally {
        state.loading = false;
      }
    }

    async function carregarInstagram(reset = false) {
      if (instagramState.loading) return;
      instagramState.loading = true;
      try {
        const res = await fetch(`${WEB_APP_URL}?action=listInstagram&page=${instagramState.page}`);
        const data = await res.json();
        if (data.erro) throw new Error(data.mensagem);

        instagramState.allItems = instagramState.allItems.concat(data.instagram);
        instagramState.total = data.total;
        instagramState.page++;
        renderizarCarrossel('instagram');
        atualizarFiltros('instagram');
      } catch (e) {
        console.error('Erro instagram:', e);
      } finally {
        instagramState.loading = false;
      }
    }

    function renderizarCarrossel(tipo) {
    const state = tipo === 'motoristas' ? gruposMotoristasState : (tipo === 'comercio' ? gruposComercioState : instagramState);
    const containerId = tipo === 'motoristas' ? 'carrossel-motoristas' : (tipo === 'comercio' ? 'carrossel-comercio' : 'carrossel-instagram');
    const dotsId = tipo === 'motoristas' ? 'dots-motoristas' : (tipo === 'comercio' ? 'dots-comercio' : 'dots-instagram');
    
    const container = document.getElementById(containerId);
    const dots = document.getElementById(dotsId);
    
    container.innerHTML = '';
    dots.innerHTML = '';

    // VERIFICA√á√ÉO PRINCIPAL: Se n√£o h√° itens, mostre a mensagem de vazio e pare.
    if (state.allItems.length === 0) {
        container.innerHTML = '<div class="carrossel-vazio">Nenhum item encontrado para esta cidade.</div>';
        return;
    }

    // Garante que o √≠ndice seja v√°lido
    if (state.index < 0 || state.index >= state.allItems.length) {
        state.index = 0;
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'carrossel-wrapper';
    
    const item = state.allItems[state.index];
    const div = document.createElement('div');
    div.className = 'carrossel-item';
    
    // CORRE√á√ÉO: Usar 'display: block' e 'text-decoration: none' para o link se parecer com um bot√£o
    let html = `<img src="${item.imagem || 'https://via.placeholder.com/150/020617/FFFFFF?text=Sem+Imagem'}" class="grupo-imagem" alt="Imagem de ${item.nome}">
                <div class="grupo-info">
                  <span class="grupo-categoria">${item.categoria || 'Sem Categoria'}</span>
                  <h3 class="grupo-nome">${item.nome}</h3>`;
    
    if (tipo !== 'instagram' ) {
        // CORRE√á√ÉO: Simplificando a chamada do modal e garantindo que a descri√ß√£o seja passada corretamente
        html += `<p class="grupo-descricao">${(item.descricao || '').substring(0, 60)}${item.descricao.length > 60 ? '...' : ''}</p>
                 <div class="grupo-botao">
                    ${item.descricao ? `<button class="btn-ver-mais" onclick='abrirModalDescricao(${JSON.stringify(item)})'>Ver Descri√ß√£o</button>` : ''}
                 </div>
                 <a href="${item.link}" target="_blank" class="button" style="background:#22c55e;color:#020617;padding:12px;border-radius:10px;text-decoration:none;margin-top:10px;font-weight:bold;display:block;">Acessar Grupo</a>`;
    } else {
        html += `<p class="grupo-descricao">${item.descricao}</p>
                 <a href="${item.link}" target="_blank" class="button" style="background:#22c55e;color:#020617;padding:12px;border-radius:10px;text-decoration:none;margin-top:10px;font-weight:bold;display:block;">Ver no Instagram</a>`;
    }
    
    div.innerHTML = html + `</div>`;
    
    // Adiciona o item ao wrapper DEPOIS de montar o HTML
    wrapper.appendChild(div);
    // Adiciona o wrapper ao container
    container.appendChild(wrapper);

    // Adiciona a navega√ß√£o (setas)
    const prev = document.createElement('button');
    prev.className = 'carrossel-nav prev'; prev.innerHTML = '&#10094;';
    prev.onclick = () => mudarSlide(tipo, -1);
    container.appendChild(prev);

    const next = document.createElement('button');
    next.className = 'carrossel-nav next'; next.innerHTML = '&#10095;';
    next.onclick = () => mudarSlide(tipo, 1);
    container.appendChild(next);

    // Adiciona os pontos de pagina√ß√£o (dots)
    for (let p = 0; p < state.allItems.length; p++) {
        const dot = document.createElement('div');
        dot.className = `num-page ${p === state.index ? 'active' : ''}`;
        dot.innerText = p + 1;
        dot.onclick = () => { state.index = p; renderizarCarrossel(tipo); };
        dots.appendChild(dot);
    }
}


    async function mudarSlide(tipo, dir) {
      const state = tipo === 'motoristas' ? gruposMotoristasState : (tipo === 'comercio' ? gruposComercioState : instagramState);
      state.index += dir;
      if (state.index < 0) state.index = state.allItems.length - 1;
      if (state.index >= state.allItems.length) {
        if (state.allItems.length < state.total) {
          if (tipo === 'instagram') await carregarInstagram(); else await carregarGrupos(tipo);
        } else {
          state.index = 0;
        }
      }
      renderizarCarrossel(tipo);
    }

    function atualizarFiltros(tipo) {
      const state = tipo === 'motoristas' ? gruposMotoristasState : (tipo === 'comercio' ? gruposComercioState : instagramState);
      const selectId = tipo === 'motoristas' ? 'filtro-motoristas' : (tipo === 'comercio' ? 'filtro-comercio' : 'filtro-instagram');
      const select = document.getElementById(selectId);
      const categorias = [...new Set(state.allItems.map(i => i.categoria))].sort();
      select.innerHTML = `<option value="">Todas as Categorias</option>`;
      categorias.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.innerText = c;
        select.appendChild(opt);
      });
      select.onchange = (e) => {
        const cat = e.target.value;
        const idx = state.allItems.findIndex(i => !cat || i.categoria === cat);
        if (idx !== -1) { state.index = idx; renderizarCarrossel(tipo); }
      };
    }

    async function abrirModalMotorista(id) {
      showStatus('Carregando telefone...');
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getMotoristaDetails&id=${id}`);
        const m = await res.json();
        const modal = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        
        let html = `<h2>${m.nome}</h2><p>Motorista da Rede</p>`;
        if (m.telefoneVisivel) {
          const tel = m.icone.replace(/\D/g, '');
          html += `<div style="font-size:24px;margin:20px 0;">üìû ${m.icone}</div>
                   <button onclick="window.open('https://wa.me/55${tel}')">Chamar no WhatsApp</button>`;
        } else {
          html += `<div style="background:#334155;padding:20px;border-radius:12px;margin:20px 0;">üîí N√∫mero Privado</div>`;
        }
        html += `<button class="btn-secondary" onclick="fecharModal()" style="margin-top:10px;">Voltar</button>`;
        
        content.innerHTML = html;
        modal.style.display = 'flex';
      } finally {
        hideStatus();
      }
    }

    function abrirModalDescricao(item) {
    const modal = document.getElementById('modal-overlay');
    const content = document.getElementById('modal-content');
    content.innerHTML = `<h2>${item.nome}</h2>
                           <div class="modal-descricao-scroll"><p>${item.descricao}</p></div>
                           <button class="btn-secondary" onclick="fecharModal()">Fechar</button>`;
    modal.style.display = 'flex';
}

    function fecharModal() {
      document.getElementById('modal-overlay').style.display = 'none';
    }
  </script>
</body>
</html>
