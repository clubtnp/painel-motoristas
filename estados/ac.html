<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Rede de Motoristas</title>
  <style>
    /* Seus estilos CSS existentes aqui */
    body { font-family: Arial, sans-serif; background: #0f172a; color: #fff; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 40px 16px; box-sizing: border-box; }
    .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: 24px; }
    .box { background: #020617; padding: 24px; border-radius: 16px; box-shadow: 0 0 20px rgba(0,0,0,.5); }
    
    .capa-container { text-align: center; margin-bottom: 8px; }
    .capa-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #22c55e; object-fit: cover; box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
    .capa-titulo { margin-top: 12px; font-size: 18px; font-weight: bold; color: #22c55e; }

    h1 { text-align: center; margin-bottom: 10px; font-size: 22px; }
    p { text-align: center; font-size: 14px; opacity: .8; }
    select, button { width: 100%; padding: 14px; margin-top: 16px; border-radius: 12px; border: none; font-size: 16px; }
    select { background: #1e293b; color: #fff; }
    button { background: #22c55e; color: #020617; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
    .btn-secondary { background: #1e293b; color: #fff; }
    button:hover { opacity: .9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #status { text-align: center; font-size: 12px; margin-top: 8px; color: #22c55e; display: none; }

    #container-arvore { 
      margin-top: 20px; 
      overflow: auto; 
      height: 255px; 
      border: 1px solid #1e293b; 
      border-radius: 12px; 
      background: #020617;
      padding: 20px 0; 
      box-sizing: border-box;
      position: relative;
    }
    
    .filtro-categoria {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      background: #1e293b;
      color: #fff;
      border: 1px solid #334155;
      font-size: 14px;
      outline: none;
    }
          
    .filtro-categoria:focus {
      border-color: #22c55e;
    }

    #wrapper-arvore { 
      display: flex; 
      flex-direction: column; 
      gap: 20px; 
      width: max-content; 
      min-width: 100%;
      padding: 0 20px;
      align-items: center; 
    }

    #container-arvore::-webkit-scrollbar { width: 8px; height: 8px; }
    #container-arvore::-webkit-scrollbar-track { background: #020617; border-radius: 10px; }
    #container-arvore::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    #container-arvore::-webkit-scrollbar-thumb:hover { background: #22c55e; }

    .nivel-arvore { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 15px; 
      min-width: max-content; 
      position: relative;
    }

    .label-nivel { 
      background: #334155; 
      color: #fff; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 9px; 
      font-weight: bold; 
      text-transform: uppercase; 
      opacity: 0.6; 
      flex-shrink: 0; 
    }

    .item-motorista { 
      background: #1e293b; 
      border-radius: 8px; 
      border: 1px solid #334155; 
      cursor: pointer; 
      transition: all 0.2s; 
      flex-shrink: 0; 
      width: 110px; 
      height: 38px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
    }

    .item-motorista span { 
      white-space: nowrap; 
      font-size: 12px; 
      font-weight: 500;
      color: #e2e8f0;
    }

    .item-motorista:hover { 
      background-color: #334155; 
      transform: scale(1.05); 
      border-color: #22c55e; 
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
    }
    .carrossel-container { position: relative; margin-top: 16px; background: #1e293b; border-radius: 12px; padding: 16px; border: 1px solid #334155; min-height: 370px; display: flex; align-items: center; justify-content: center; }
    .carrossel-wrapper { display: flex; overflow: hidden; width: 100%; border-radius: 8px; position: relative; min-height: 330px; }
    .carrossel-item { flex: 0 0 100%; display: flex; flex-direction: column; gap: 12px; transition: transform 0.3s ease; align-items: center; text-align: center; position: absolute; top: 0; left: 0; width: 100%; }
    .grupo-imagem { width: 150px; height: 150px; border-radius: 12px; object-fit: cover; background: #0f172a; border: 1px solid #334155; }
    .grupo-info { display: flex; flex-direction: column; gap: 6px; width: 100%; }
    .grupo-nome { font-size: 18px; font-weight: bold; color: #22c55e; line-height: 1.2; cursor: pointer; padding: 0 10px; word-wrap: break-word; }
    .grupo-categoria { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-ver-mais { background: #334155; color: #fff; border: 1px solid #475569; border-radius: 8px; padding: 6px 16px; font-size: 12px; font-weight: bold; cursor: pointer; }
    .grupo-botao { 
      min-height: 44px; /* Garante que o bot√£o tenha altura mesmo sem texto */
      display: flex;
      align-items: center;
      justify-content: center }
    
    .carrossel-nav { 
      position: absolute; top: 50%; transform: translateY(-50%); 
      background: rgba(34, 197, 94, 0.8); color: #020617; border: none; 
      width: 36px; height: 36px; border-radius: 50%; cursor: pointer; 
      font-size: 18px; font-weight: bold; z-index: 10; 
      display: flex; align-items: center; justify-content: center; 
    }
    .carrossel-nav.prev { left: 8px; }
    .carrossel-nav.next { right: 8px; }

    .carrossel-dots { 
      display: flex; justify-content: center; align-items: center; 
      gap: 6px; margin-top: 14px; min-height: 32px; flex-wrap: wrap;
    }

    .num-page { 
      min-width: 30px; height: 30px; padding: 0 4px; border-radius: 6px; 
      background: #1e293b; color: #fff; font-size: 12px; font-weight: bold;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      border: 1px solid #334155; transition: 0.2s;
    }

    .num-page.active { 
      background: #22c55e; color: #020617; border-color: #22c55e; 
    }

    .num-page.dots { 
      background: transparent; border: none; cursor: default; color: #94a3b8; 
    }

    .num-page:hover:not(.dots):not(.active) { 
      background: #334155; border-color: #22c55e; 
    }

    .carrossel-vazio { 
      text-align: center; color: #94a3b8; font-style: italic; padding: 20px; 
    }

    .modal-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.85); 
      display: none; 
      justify-content: center; 
      align-items: center; 
      z-index: 100000; 
      backdrop-filter: blur(5px); 
      padding: 20px;
      box-sizing: border-box;
    }
    
    .modal-content { 
      background: #1e293b; 
      padding: 24px; 
      border-radius: 20px; 
      width: 100%;
      max-width: 360px; 
      text-align: center; 
      border: 1px solid #334155; 
      display: flex; 
      flex-direction: column; 
      max-height: 85vh; 
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      position: relative;
      margin: auto;
    }

    .modal-descricao-scroll { 
      flex: 1; 
      overflow-y: scroll !important; 
      overflow-x: hidden; 
      padding: 15px; 
      background: #0f172a; 
      border-radius: 12px; 
      text-align: left; 
      margin: 15px 0; 
      border: 1px solid #334155;
      -webkit-overflow-scrolling: touch; 
    }

    .modal-descricao-scroll p {
      margin: 0;
      font-size: 14px;
      line-height: 1.6;
      color: #cbd5e1;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }

    .modal-descricao-scroll::-webkit-scrollbar { 
      width: 8px !important; 
      display: block !important;
    }
    .modal-descricao-scroll::-webkit-scrollbar-track { 
      background: #020617; 
      border-radius: 10px;
    }
    .modal-descricao-scroll::-webkit-scrollbar-thumb { 
      background: #22c55e; 
      border-radius: 10px;
      border: 2px solid #0f172a; 
    }
    .modal-descricao-scroll::-webkit-scrollbar-thumb:hover { 
      background: #16a34a; 
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="capa-container">
      <img src="https://files.manuscdn.com/user_upload_by_module/session_file/310519663183776805/TBToCHjaxmWFWXCg.png" alt="Capa" class="capa-img">
      <div class="capa-titulo">Pessoas Colaborativas ganham at√© dormindo</div>
    </div>

    <div class="box">
      <h1>Buscar motoristas</h1>
      <p>Escolha seu estado e cidade</p>
      <!-- Adicione este select se voc√™ n√£o tiver um para o estado -->
      <select id="estado-select">
          <option value="AC">Acre</option>
          <!-- Adicione outros estados conforme necess√°rio -->
      </select>
      <select id="selectCidade"><option value="">Carregando cidades...</option></select>
      <button id="btnBuscar">Buscar motoristas</button>
      <div id="status"></div>
    </div>

    <div class="box">
      <h1>√Årvore da Rede</h1>
      <p>Arraste para explorar</p>
      <div id="container-arvore"><div id="wrapper-arvore"></div></div>
      <button id="btnCadastrarArvore">Cadastrar na √°rvore</button>
    </div>

    <div class="box">
      <h1>Grupo de Motoristas</h1>
      <div id="carrossel-motoristas" class="carrossel-container"></div>
      <div id="dots-motoristas" class="carrossel-dots"></div>
      <select id="filtro-motoristas" class="filtro-categoria">
        <option value="">Filtrar por Categoria (Motoristas )</option>
      </select>
      <button class="btn-secondary" id="btnCadastrarGrupo">Cadastrar meu grupo</button>
    </div>

    <div class="box">
      <h1>Grupos de Com√©rcios</h1>
      <div id="carrossel-comercio" class="carrossel-container"></div>
      <div id="dots-comercio" class="carrossel-dots"></div>
      <select id="filtro-comercio" class="filtro-categoria">
        <option value="">Filtrar por Categoria (Com√©rcio)</option>
      </select>
    </div>

    <div class="box">
      <h1>Instagram</h1>
      <div id="carrossel-instagram" class="carrossel-container"></div>
      <div id="dots-instagram" class="carrossel-dots"></div>
      <select id="filtro-instagram" class="filtro-categoria">
        <option value="">Filtrar por Categoria (Instagram)</option>
      </select>
    </div>

    <!-- Modal para detalhes -->
    <div id="modal-overlay" class="modal-overlay">
      <div id="modal-content" class="modal-content"></div>
    </div>

  <script>
    const WEB_APP_URL = 'SEU_URL_DE_IMPLANTACAO_DO_APPS_SCRIPT'; // **ATUALIZE COM O SEU URL**
    let estadoAtual = 'AC'; // Pode ser din√¢mico se voc√™ tiver um seletor de estado
    let cidadeAtual = '';

    // Vari√°veis para pagina√ß√£o e estado
    const motoristasState = { page: 1, pageSize: 200, total: 0, loading: false, allMotoristas: [] };
    const gruposMotoristasState = { page: 1, pageSize: 5, total: 0, loading: false, allGrupos: [] };
    const gruposComercioState = { page: 1, pageSize: 5, total: 0, loading: false, allGrupos: [] };
    const instagramState = { page: 1, pageSize: 5, total: 0, loading: false, allItems: [] };

    document.addEventListener('DOMContentLoaded', () => {
      const selectCidade = document.getElementById('selectCidade');
      const btnBuscar = document.getElementById('btnBuscar');
      const selectEstado = document.getElementById('estado-select'); // Obter o seletor de estado

      // Atualiza estadoAtual se o seletor de estado existir
      if (selectEstado) {
        estadoAtual = selectEstado.value;
        selectEstado.addEventListener('change', () => {
          estadoAtual = selectEstado.value;
          if (cidadeAtual) { // Se j√° houver uma cidade selecionada, busca os dados novamente
            buscarTodosDadosPaginados();
          }
        });
      }

      carregarCidades();
      selectCidade.addEventListener('change', () => {
        cidadeAtual = selectCidade.value;
        if (cidadeAtual) {
          buscarTodosDadosPaginados();
        } else {
          limparResultados();
        }
      });
      btnBuscar.addEventListener('click', buscarTodosDadosPaginados);

      // Evento de scroll para carregamento incremental da √°rvore
      const containerArvore = document.getElementById('container-arvore');
      containerArvore.addEventListener('scroll', () => {
        if (containerArvore.scrollTop + containerArvore.clientHeight >= containerArvore.scrollHeight - 50) { // 50px antes do final
          carregarMaisMotoristas();
        }
      });

      // Eventos do modal
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') fecharModal(); });
      document.getElementById('modal-overlay').addEventListener('click', (e) => { if (e.target.id === 'modal-overlay') fecharModal(); });
    });

    function showLoading(message = 'Carregando...') {
      const statusDiv = document.getElementById('status');
      const btnBuscar = document.getElementById('btnBuscar');
      const selectCidade = document.getElementById('selectCidade');
      const selectEstado = document.getElementById('estado-select');
      
      statusDiv.style.display = 'block';
      statusDiv.innerText = message;
      btnBuscar.disabled = true;
      selectCidade.disabled = true;
      if (selectEstado) selectEstado.disabled = true;
      // Adicionar um spinner ou √≠cone de carregamento aqui
    }

    function hideLoading() {
      const statusDiv = document.getElementById('status');
      const btnBuscar = document.getElementById('btnBuscar');
      const selectCidade = document.getElementById('selectCidade');
      const selectEstado = document.getElementById('estado-select');

      statusDiv.style.display = 'none';
      statusDiv.innerText = '';
      btnBuscar.disabled = false;
      selectCidade.disabled = false;
      if (selectEstado) selectEstado.disabled = false;
      // Remover spinner ou √≠cone de carregamento
    }

    function limparResultados() {
      document.getElementById('wrapper-arvore').innerHTML = '';
      document.getElementById('carrossel-motoristas').innerHTML = '';
      document.getElementById('dots-motoristas').innerHTML = '';
      document.getElementById('filtro-motoristas').innerHTML = '<option value="">Filtrar por Categoria (Motoristas )</option>';
      document.getElementById('carrossel-comercio').innerHTML = '';
      document.getElementById('dots-comercio').innerHTML = '';
      document.getElementById('filtro-comercio').innerHTML = '<option value="">Filtrar por Categoria (Com√©rcio)</option>';
      document.getElementById('carrossel-instagram').innerHTML = '';
      document.getElementById('dots-instagram').innerHTML = '';
      document.getElementById('filtro-instagram').innerHTML = '<option value="">Filtrar por Categoria (Instagram)</option>';

      // Resetar estados de pagina√ß√£o
      motoristasState.page = 1; motoristasState.allMotoristas = []; motoristasState.total = 0; motoristasState.loading = false;
      gruposMotoristasState.page = 1; gruposMotoristasState.allGrupos = []; gruposMotoristasState.total = 0; gruposMotoristasState.loading = false;
      gruposComercioState.page = 1; gruposComercioState.allGrupos = []; gruposComercioState.total = 0; gruposComercioState.loading = false;
      instagramState.page = 1; instagramState.allItems = []; instagramState.total = 0; instagramState.loading = false;
    }

    async function carregarCidades() {
      const cidadeSelect = document.getElementById('selectCidade');
      cidadeSelect.innerHTML = '<option value="">Carregando cidades...</option>';
      showLoading('Carregando cidades...');
      try {
        const response = await fetch(`${WEB_APP_URL}?action=listCidades`);
        const cidades = await response.json();
        cidadeSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
        cidades.forEach(cidade => {
          const option = document.createElement('option');
          option.value = cidade;
          option.textContent = cidade;
          cidadeSelect.appendChild(option);
        });
        if (cidades.length > 0) {
          cidadeAtual = cidades[0]; // Seleciona a primeira cidade por padr√£o
          selectCidade.value = cidadeAtual;
          buscarTodosDadosPaginados(); // Busca dados para a primeira cidade
        }
      } catch (error) {
        console.error('Erro ao carregar cidades:', error);
        cidadeSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        document.getElementById('status').innerText = 'Erro ao carregar cidades.';
      } finally {
        hideLoading();
      }
    }

    async function buscarTodosDadosPaginados() {
      if (!cidadeAtual) {
        document.getElementById('status').innerText = 'Por favor, selecione uma cidade.';
        return;
      }

      limparResultados(); // Limpa resultados anteriores e reseta estados
      showLoading('Buscando dados...');

      try {
        // Carregar motoristas (primeira p√°gina)
        await carregarMotoristas(true);

        // Carregar grupos de motoristas (primeira p√°gina)
        await carregarGrupos('motoristas', true);

        // Carregar grupos de com√©rcio (primeira p√°gina)
        await carregarGrupos('comercio', true);

        // Carregar Instagram (primeira p√°gina)
        await carregarInstagram(true);

      } catch (error) {
        console.error('Erro ao buscar todos os dados:', error);
        document.getElementById('status').innerText = `Erro ao buscar dados: ${error.message}`;
      } finally {
        hideLoading();
      }
    }

    async function carregarMotoristas(reset = false) {
      if (motoristasState.loading) return;
      if (!reset && motoristasState.allMotoristas.length >= motoristasState.total && motoristasState.total > 0) return; // J√° carregou tudo

      motoristasState.loading = true;
      showLoading('Carregando motoristas...');

      try {
        const response = await fetch(`${WEB_APP_URL}?action=listMotoristas&estado=${estadoAtual}&cidade=${cidadeAtual}&page=${motoristasState.page}&pageSize=${motoristasState.pageSize}`);
        const data = await response.json();

        if (data.erro) {
          console.error('Erro ao carregar motoristas:', data.mensagem);
          document.getElementById('status').innerText = `Erro: ${data.mensagem}`;
          return;
        }

        if (reset) {
          motoristasState.allMotoristas = [];
          document.getElementById('wrapper-arvore').innerHTML = '';
        }

        motoristasState.allMotoristas = motoristasState.allMotoristas.concat(data.motoristas);
        motoristasState.total = data.total;
        motoristasState.page++;

        renderizarArvorePorNiveis(motoristasState.allMotoristas); // Renderiza a √°rvore com todos os motoristas carregados

      } catch (error) {
        console.error('Erro ao carregar motoristas:', error);
        document.getElementById('status').innerText = `Erro ao carregar motoristas: ${error.message}`;
      } finally {
        motoristasState.loading = false;
        hideLoading();
      }
    }

    function carregarMaisMotoristas() {
      if (motoristasState.loading || motoristasState.allMotoristas.length >= motoristasState.total) return;
      carregarMotoristas();
    }

    async function carregarGrupos(tipo, reset = false, page = 1) {
      const state = tipo === 'motoristas' ? gruposMotoristasState : gruposComercioState;
      const containerId = tipo === 'motoristas' ? 'carrossel-motoristas' : 'carrossel-comercio';
      const dotsId = tipo === 'motoristas' ? 'dots-motoristas' : 'dots-comercio';
      const filtroId = tipo === 'motoristas' ? 'filtro-motoristas' : 'filtro-comercio';

      if (state.loading) return;
      // Verifica se j√° carregou tudo ou se a p√°gina solicitada j√° est√° no cache local
      if (!reset && page > 1 && state.allGrupos.length >= state.total && state.total > 0) return; 

      state.loading = true;
      showLoading(`Carregando grupos de ${tipo}...`);

      try {
        const response = await fetch(`${WEB_APP_URL}?action=listGrupos&type=${tipo}&estado=${estadoAtual}&cidade=${cidadeAtual}&page=${page}&pageSize=${state.pageSize}`);
        const data = await response.json();

        if (data.erro) {
          console.error(`Erro ao carregar grupos de ${tipo}:`, data.mensagem);
          document.getElementById('status').innerText = `Erro: ${data.mensagem}`;
          return;
        }

        if (reset) {
          state.allGrupos = [];
        }
        state.allGrupos = state.allGrupos.concat(data.grupos);
        state.total = data.total;
        state.page = page + 1; // Atualiza para a pr√≥xima p√°gina a ser carregada

        renderizarCarrossel(tipo, state.allGrupos, containerId, dotsId, filtroId);
        atualizarFiltrosCategoriasCarrossel(tipo, state.allGrupos, filtroId);

      } catch (error) {
        console.error(`Erro ao carregar grupos de ${tipo}:`, error);
        document.getElementById('status').innerText = `Erro ao carregar grupos de ${tipo}: ${error.message}`;
      } finally {
        state.loading = false;
        hideLoading();
      }
    }

    async function carregarInstagram(reset = false, page = 1) {
      const state = instagramState;
      const containerId = 'carrossel-instagram';
      const dotsId = 'dots-instagram';
      const filtroId = 'filtro-instagram';

      if (state.loading) return;
      // Verifica se j√° carregou tudo ou se a p√°gina solicitada j√° est√° no cache local
      if (!reset && page > 1 && state.allItems.length >= state.total && state.total > 0) return; 

      state.loading = true;
      showLoading('Carregando Instagram...');

      try {
        const response = await fetch(`${WEB_APP_URL}?action=listInstagram&estado=${estadoAtual}&cidade=${cidadeAtual}&page=${page}&pageSize=${state.pageSize}`);
        const data = await response.json();

        if (data.erro) {
          console.error('Erro ao carregar Instagram:', data.mensagem);
          document.getElementById('status').innerText = `Erro: ${data.mensagem}`;
          return;
        }

        if (reset) {
          state.allItems = [];
        }
        state.allItems = state.allItems.concat(data.instagram);
        state.total = data.total;
        state.page = page + 1; // Atualiza para a pr√≥xima p√°gina a ser carregada

        renderizarCarrossel('instagram', state.allItems, containerId, dotsId, filtroId);
        atualizarFiltrosCategoriasCarrossel('instagram', state.allItems, filtroId);

      } catch (error) {
        console.error('Erro ao carregar Instagram:', error);
        document.getElementById('status').innerText = `Erro ao carregar Instagram: ${error.message}`;
      } finally {
        state.loading = false;
        hideLoading();
      }
    }

    // Fun√ß√£o para renderizar a √°rvore (adaptada para receber a lista completa de motoristas)
    function renderizarArvorePorNiveis(motoristasList) {
      const wrapper = document.getElementById('wrapper-arvore');
      wrapper.innerHTML = ""; // Limpa antes de renderizar tudo
      if (!motoristasList || motoristasList.length === 0) {
        wrapper.innerHTML = "<p style='opacity:0.5;'>Nenhum motorista.</p>";
        return;
      }

      const fragment = document.createDocumentFragment();
      const arvore = montarArvoreLocal(motoristasList); // Adapta√ß√£o: montar a √°rvore no frontend

      arvore.forEach((nivelLista, indexNivel) => {
        const divNivel = document.createElement('div');
        divNivel.className = 'nivel-arvore';
        const label = document.createElement('div');
        label.className = 'label-nivel';
        label.innerText = `N√≠vel ${indexNivel + 1}`;
        divNivel.appendChild(label);
        
        nivelLista.forEach(m => {
          const item = document.createElement('div');
          item.className = 'item-motorista';
          item.innerHTML = `<span>${(m.nome || "Motorista").split(" ")[0]}</span>`;
          item.onclick = () => abrirModalMotorista(m.id); // Passa apenas o ID
          divNivel.appendChild(item);
        });
        
        const labelFim = label.cloneNode(true);
        divNivel.appendChild(labelFim);
        fragment.appendChild(divNivel);
      });
      
      wrapper.appendChild(fragment);
    }

    // Fun√ß√£o para montar a √°rvore (agora no frontend, para otimizar)
    function montarArvoreLocal(lista) {
      const niveis = [];
      let indiceAtual = 0;
      let tamanhoDoNivel = 3; // Come√ßa com 3

      while (indiceAtual < lista.length) {
        const nivel = lista.slice(indiceAtual, indiceAtual + tamanhoDoNivel);
        niveis.push(nivel);
        indiceAtual += tamanhoDoNivel;
        tamanhoDoNivel += 2; // Aumenta de 2 em 2
      }
      return niveis;
    }

    // Fun√ß√£o para renderizar carrossel (adaptada para pagina√ß√£o)
    function renderizarCarrossel(tipo, items, containerId, dotsId, filtroId) {
      const container = document.getElementById(containerId);
      const dotsContainer = document.getElementById(dotsId);
      container.innerHTML = '';
      dotsContainer.innerHTML = '';

      if (!items || items.length === 0) {
        container.innerHTML = '<div class="carrossel-vazio">Nenhum item encontrado.</div>';
        return;
      }

      const state = tipo === 'motoristas' ? gruposMotoristasState : 
                    tipo === 'comercio' ? gruposComercioState : instagramState;
      const totalPages = Math.ceil(state.total / state.pageSize);

      // Determina qual p√°gina de itens exibir no carrossel
      // state.page j√° foi incrementado para a pr√≥xima busca, ent√£o usamos (state.page - 1) para a p√°gina atual
      const currentPage = state.page - 1;
      const startIndex = (currentPage - 1) * state.pageSize;
      const endIndex = startIndex + state.pageSize;
      const itemsToRender = items.slice(startIndex, endIndex);

      const wrapper = document.createElement('div');
      wrapper.className = 'carrossel-wrapper';

      itemsToRender.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'carrossel-item';
        itemDiv.style.transform = `translateX(${index * 100}%)`; // Ajuste para mostrar um por vez
        
        let contentHTML = '';
        if (tipo === 'instagram') {
          contentHTML = `
            <img src="${item.imagem}" alt="${item.nome}" class="grupo-imagem">
            <div class="grupo-info">
              <span class="grupo-categoria">${item.categoria}</span>
              <h3 class="grupo-nome">${item.nome}</h3>
              <p class="grupo-descricao">${item.descricao}</p>
              <a href="${item.link}" target="_blank" class="btn-ver-mais grupo-botao">${item.textoBotao}</a>
            </div>
          `;
        } else { // Grupos de motoristas e com√©rcio
          contentHTML = `
            <img src="${item.imagem || 'https://via.placeholder.com/150?text=Grupo'}" alt="${item.nome}" class="grupo-imagem">
            <div class="grupo-info">
              <span class="grupo-categoria">${item.categoria}</span>
              <h3 class="grupo-nome">${item.nome}</h3>
              <p class="grupo-descricao">${item.descricao}</p>
              <button class="btn-ver-mais grupo-botao" onclick="abrirModalGrupo(${JSON.stringify(item).replace(/'/g, '&apos;')})">Ver Descri√ß√£o</button>
              <a href="${item.link}" target="_blank" class="btn-ver-mais grupo-botao">Acessar Grupo</a>
            </div>
          `;
        }
        itemDiv.innerHTML = contentHTML;
        wrapper.appendChild(itemDiv);
      });

      container.appendChild(wrapper);

      // Bot√µes de navega√ß√£o (prev/next)
      const prevBtn = document.createElement('button');
      prevBtn.className = 'carrossel-nav prev';
      prevBtn.innerHTML = '&#10094;';
      prevBtn.onclick = () => navegarCarrossel(tipo, -1);
      container.appendChild(prevBtn);

      const nextBtn = document.createElement('button');
      nextBtn.className = 'carrossel-nav next';
      nextBtn.innerHTML = '&#10095;';
      nextBtn.onclick = () => navegarCarrossel(tipo, 1);
      container.appendChild(nextBtn);

      // Pagina√ß√£o num√©rica (dots)
      for (let i = 1; i <= totalPages; i++) {
        const dot = document.createElement('button');
        dot.className = `num-page ${i === currentPage ? 'active' : ''}`;
        dot.innerText = i;
        dot.onclick = () => navegarCarrossel(tipo, 0, i);
        dotsContainer.appendChild(dot);
      }
    }

    // Fun√ß√£o para navegar no carrossel
    async function navegarCarrossel(tipo, direction, specificPage = null) {
      const state = tipo === 'motoristas' ? gruposMotoristasState : 
                    tipo === 'comercio' ? gruposComercioState : instagramState;
      const totalPages = Math.ceil(state.total / state.pageSize);

      let newPage = specificPage || (state.page - 1) + direction;
      if (newPage < 1) newPage = totalPages;
      if (newPage > totalPages) newPage = 1;

      // Se a p√°gina j√° foi carregada, apenas renderiza
      // Verifica se a p√°gina que queremos exibir j√° est√° no array allGrupos/allItems
      if (state.allGrupos.length >= newPage * state.pageSize || state.allItems.length >= newPage * state.pageSize || newPage === 1) {
        state.page = newPage + 1; // Ajusta o estado para a pr√≥xima p√°gina a ser carregada
        renderizarCarrossel(tipo, state.allGrupos || state.allItems, 
                            tipo === 'motoristas' ? 'carrossel-motoristas' : tipo === 'comercio' ? 'carrossel-comercio' : 'carrossel-instagram',
                            tipo === 'motoristas' ? 'dots-motoristas' : tipo === 'comercio' ? 'dots-comercio' : 'dots-instagram',
                            tipo === 'motoristas' ? 'filtro-motoristas' : tipo === 'comercio' ? 'filtro-comercio' : 'filtro-instagram');
      } else { // Caso contr√°rio, busca a nova p√°gina
        await carregarGrupos(tipo, false, newPage);
      }
    }

    // Adapta√ß√£o da fun√ß√£o de filtros de categoria para usar os dados paginados
    function atualizarFiltrosCategoriasCarrossel(tipo, items, filtroId) {
      const select = document.getElementById(filtroId);
      if (!select) return;

      const categorias = [...new Set(items.map(i => i.categoria))]
        .filter(c => c && c.trim() !== "")
        .sort((a, b) => a.localeCompare(b, 'pt-BR'));

      select.innerHTML = `<option value="">Todas as Categorias (${tipo === 'motoristas' ? 'Motoristas' : tipo === 'comercio' ? 'Com√©rcio' : 'Instagram'})</option>`;
      categorias.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });

      select.onchange = () => {
        const selecionada = select.value;
        const listaOriginal = items; // J√° √© a lista completa carregada at√© o momento
        
        const filtrados = selecionada 
          ? listaOriginal.filter(i => i.categoria === selecionada)
          : listaOriginal;
        
        // Ao filtrar, renderizamos a primeira p√°gina dos itens filtrados
        const state = tipo === 'motoristas' ? gruposMotoristasState : 
                      tipo === 'comercio' ? gruposComercioState : instagramState;
        state.page = 2; // Resetar para a primeira p√°gina (1) + 1 para o c√°lculo do renderizarCarrossel

        renderizarCarrossel(tipo, filtrados, 
                            tipo === 'motoristas' ? 'carrossel-motoristas' : tipo === 'comercio' ? 'carrossel-comercio' : 'carrossel-instagram',
                            tipo === 'motoristas' ? 'dots-motoristas' : tipo === 'comercio' ? 'dots-comercio' : 'dots-instagram',
                            filtroId);
      };
    }

    // Fun√ß√£o para abrir modal de grupo (inalterada)
    function abrirModalGrupo(item) {
      const modal = document.getElementById('modal-overlay');
      const content = document.getElementById('modal-content');
      content.innerHTML = `
        <h2 style="margin: 0 0 10px 0; color: #22c55e; font-size: 20px; flex-shrink: 0;">Descri√ß√£o</h2>
        <div class="modal-descricao-scroll">
            <p>${item.descricao || 'Sem descri√ß√£o dispon√≠vel.'}</p>
        </div>
        <button class="btn-secondary" onclick="fecharModal()" style="cursor: pointer; width: 100%; flex-shrink: 0; margin-top: 10px; padding: 14px;">Fechar</button>
      `;
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      setTimeout(() => { content.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
    }

    // Fun√ß√£o para abrir modal de motorista (agora busca detalhes sob demanda)
    async function abrirModalMotorista(motoristaId) {
      showLoading('Carregando detalhes do motorista...');
      try {
        const response = await fetch(`${WEB_APP_URL}?action=getMotoristaDetails&id=${motoristaId}`);
        const m = await response.json();

        if (m.erro) {
          console.error('Erro ao carregar detalhes do motorista:', m.mensagem);
          document.getElementById('status').innerText = `Erro: ${m.mensagem}`;
          return;
        }

        const modal = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        const nome = m.nome || "Motorista";
        
        let numeroLimpo = String(m.icone || '').replace(/\D/g, '');
        const podeMostrar = m.telefoneVisivel === true && numeroLimpo.length >= 10;

        let corpo = "";
        if (podeMostrar) {
          const ddd = numeroLimpo.substring(0, 2);
          const ini = numeroLimpo.substring(2, 7);
          const fim = numeroLimpo.substring(7);
          const numeroFormatado = `(${ddd}) ${ini}-${fim}`;

          corpo = `
            <div style="font-size:22px;font-weight:bold;color:#22c55e;">${nome}</div>
            <p style="font-size:13px;color:#94a3b8;margin:6px 0 18px 0;">Motorista da rede</p>
            <div style="font-size:20px;font-weight:bold;margin-bottom:20px;">
              üìû ${numeroFormatado}
            </div>
            <button class="grupo-botao"
              onclick="window.open('https://wa.me/55${numeroLimpo}','_blank')"
              style="cursor:pointer;background:#22c55e;color:#020617;width:100%;padding:14px;border-radius:10px;">
              Chamar no WhatsApp
            </button>
          `;
        } else {
          corpo = `
            <div style="font-size:22px;font-weight:bold;">${nome}</div>
            <p style="font-size:13px;color:#94a3b8;margin:10px 0 20px 0;">Motorista da rede</p>
            <div style="background:#0f172a;padding:16px;border-radius:10px;border:1px solid #334155;">
              <strong style="color:#ef4444;">N√∫mero privado</strong>
              <p style="font-size:12px;color:#94a3b8;margin-top:6px;">Este motorista optou por n√£o exibir o contato.</p>
            </div>
          `;
        }
        content.innerHTML = `${corpo}<button class="btn-secondary" onclick="fecharModal()" style="margin-top:16px;width:100%;padding:14px;">Voltar</button>`;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        setTimeout(() => { content.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);

      } catch (error) {
        console.error('Erro ao carregar detalhes do motorista:', error);
        document.getElementById('status').innerText = `Erro ao carregar detalhes: ${error.message}`;
      } finally {
        hideLoading();
      }
    }

    function fecharModal() {
      const modal = document.getElementById('modal-overlay');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

  </script>
</body>
</html>
